{% extends "./index.html" %}

{% block title %}数据分析系统 - 项目管理{% endblock %}

{% block page_title %}项目管理{% endblock %}

{% block project_list_active %}active{% endblock %}

{% block content %}
<!-- 项目列表页面内容 -->
<div id="project-list-page" class="page-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>项目管理</h3>
        <a href="/data/project/add" class="btn btn-primary" id="add-project-btn">
            <i class="bi bi-plus-circle me-2"></i>添加项目
        </a>
    </div>

    <!-- 统计卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="content-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-primary" id="total-projects">0</h5>
                            <p class="card-text">总项目数</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-folder text-primary" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="content-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-success" id="active-projects">0</h5>
                            <p class="card-text">进行中</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-play-circle text-success" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="content-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-warning" id="pending-projects">0</h5>
                            <p class="card-text">待启动</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-clock text-warning" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="content-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-info" id="completed-projects">0</h5>
                            <p class="card-text">已完成</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-check-circle text-info" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 项目列表 -->
    <div class="content-card">
        <div class="card-header">
            <h5 class="mb-0">项目列表</h5>
        </div>
        <div class="card-body p-0">
            <!-- 加载提示 -->
            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2 ms-2">正在加载项目数据...</p>
            </div>

            <!-- 项目列表容器 -->
            <div id="projectList" class="p-3">
                <!-- 项目卡片将通过JavaScript动态生成 -->
            </div>

            <!-- 空状态提示 -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
                <h4 class="mt-3">暂无项目</h4>
                <p class="text-muted">还没有创建任何项目，点击"添加项目"按钮开始创建</p>
                <a href="/data/project/add" class="btn btn-primary mt-3" id="create-first-project">创建第一个项目</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function () {
        // 加载项目列表
        loadProjects();
    });

    // 加载项目列表
    function loadProjects() {
        const projectList = document.getElementById('projectList');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const emptyState = document.getElementById('emptyState');

        // 显示加载提示，隐藏其他内容
        loadingSpinner.style.display = 'flex';
        projectList.innerHTML = '';
        emptyState.style.display = 'none';

        // 同时加载统计数据和项目列表
        Promise.all([
            fetch('/data/api/project/stats').then(response => response.json()),
            fetch('/data/api/projects').then(response => response.json())
        ])
            .then(([statsResponse, projectsResponse]) => {
                loadingSpinner.style.display = 'none';

                // 处理统计数据
                if (statsResponse.success) {
                    updateStatsCards(statsResponse.stats);
                }

                // 处理项目列表
                if (projectsResponse.success && projectsResponse.projects.length > 0) {
                    renderProjects(projectsResponse.projects);
                } else {
                    emptyState.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('加载数据失败:', error);
                loadingSpinner.style.display = 'none';
                emptyState.style.display = 'block';
                showMessage('加载项目数据失败: ' + error.message, 'danger');
            });
    }

    function updateStatsCards(stats) {
        // 更新总项目数
        const totalElement = document.getElementById('total-projects');
        if (totalElement) {
            totalElement.textContent = stats.total || 0;
        }

        // 更新进行中项目数
        const activeElement = document.getElementById('active-projects');
        if (activeElement) {
            activeElement.textContent = stats.active || 0;
        }

        // 更新待启动项目数
        const pendingElement = document.getElementById('pending-projects');
        if (pendingElement) {
            pendingElement.textContent = stats.pending || 0;
        }

        // 更新已完成项目数
        const completedElement = document.getElementById('completed-projects');
        if (completedElement) {
            completedElement.textContent = stats.completed || 0;
        }
    }

    // 渲染项目列表
    function renderProjects(projects) {
        const projectList = document.getElementById('projectList');
        projectList.innerHTML = '';

        // 创建行容器
        const row = document.createElement('div');
        row.className = 'row';

        projects.forEach(project => {
            const projectCard = createProjectCard(project);
            row.appendChild(projectCard);
        });

        projectList.appendChild(row);
    }

    // 创建项目卡片
    function createProjectCard(project) {
        const col = document.createElement('div');
        col.className = 'col-12 mb-3';

        // 格式化用户列表
        const userBadges = project.users ? project.users.map(user =>
            `<span class="user-badge">${escapeHtml(user.username)}</span>`
        ).join('') : '<span class="text-muted">暂无成员</span>';

        // 格式化创建时间
        const createdTime = project.created_at ? formatDate(project.created_at) : '未知';
        const updatedTime = project.updated_at ? formatDate(project.updated_at) : '未知';

        col.innerHTML = `
            <div class="card project-card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="card-title">${escapeHtml(project.name)}</h5>
                            <p class="card-text">${project.description ? escapeHtml(project.description) : '<span class="text-muted">暂无描述</span>'}</p>
                            <div class="mb-2">
                                <small class="text-muted">项目成员:</small>
                                <div>${userBadges}</div>
                            </div>
                            <div class="text-muted small">
                                <span>创建: ${createdTime}</span>
                                <span class="ms-3">更新: ${updatedTime}</span>
                                <span class="ms-3">ID: ${project.id}</span>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group-sm">
                                <button class="btn btn-outline-primary btn-sm" onclick="viewProject(${project.id})">
                                    <i class="bi bi-folder2-open me-1"></i>进入项目
                                </button>
                                <a href="/data/projects/${project.id}/edit" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-pencil me-1"></i>编辑
                                </a>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteProject(${project.id}, '${escapeHtml(project.name)}')">
                                    <i class="bi bi-trash me-1"></i>删除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        return col;
    }

    // 查看项目详情
    function viewProject(projectId) {
        // 跳转到项目详情首页
        window.location.href = `/data/projects/${projectId}/index`;
    }

    // 删除项目函数
    function deleteProject(projectId, projectName) {
        // 设置删除确认模态框内容
        document.getElementById('deleteProjectName').textContent = projectName;

        // 显示确认模态框
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();

        // 设置确认删除按钮的点击事件
        document.getElementById('confirmDeleteBtn').onclick = function () {
            performDeleteProject(projectId, modal);
        };
    }

    // 执行删除项目操作
    function performDeleteProject(projectId, modal) {
        fetch(`/data/api/project/${projectId}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应不正常');
                }
                return response.json();
            })
            .then(data => {
                modal.hide();
                if (data.success) {
                    showMessage('项目删除成功', 'success');
                    // 重新加载项目列表
                    loadProjects();
                } else {
                    showMessage('删除失败: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                modal.hide();
                showMessage('删除项目时发生错误: ' + error.message, 'danger');
            });
    }

    // 格式化日期函数
    function formatDate(dateString) {
        if (!dateString) return '-';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        } catch (error) {
            console.error('日期格式化错误:', error);
            return '-';
        }
    }

    // 显示消息函数（使用基础模板中的函数）
    function showMessage(message, type) {
        // 创建消息元素
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <strong>${type === 'success' ? '成功!' : type === 'danger' ? '错误!' : '警告!'}</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        // 插入到内容容器顶部
        const contentContainer = document.getElementById('content-container');
        const firstChild = contentContainer.firstChild;
        if (firstChild) {
            contentContainer.insertBefore(alertDiv, firstChild);
        } else {
            contentContainer.appendChild(alertDiv);
        }

        // 5秒后自动隐藏
        setTimeout(() => {
            if (alertDiv.parentNode) {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                bsAlert.close();
            }
        }, 5000);
    }
</script>
{% endblock %}